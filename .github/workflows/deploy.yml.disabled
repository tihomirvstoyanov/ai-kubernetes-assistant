name: Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    - name: Configure kubectl
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG }}

    - name: Set deployment variables
      id: vars
      run: |
        ENV="${{ github.event.inputs.environment || 'staging' }}"
        TAG="${{ github.event.inputs.image_tag || 'latest' }}"
        NAMESPACE="ai-log-tool-${ENV}"
        
        echo "environment=${ENV}" >> $GITHUB_OUTPUT
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "namespace=${NAMESPACE}" >> $GITHUB_OUTPUT
        echo "release_name=ai-log-tool-${ENV}" >> $GITHUB_OUTPUT

    - name: Create namespace
      run: |
        kubectl create namespace ${{ steps.vars.outputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -

    - name: Deploy with Helm
      run: |
        helm upgrade --install ${{ steps.vars.outputs.release_name }} ./helm-chart \
          --namespace ${{ steps.vars.outputs.namespace }} \
          --set image.repository=${{ secrets.DOCKERHUB_USERNAME }}/ai-log-tool \
          --set image.tag=${{ steps.vars.outputs.tag }} \
          --set config.groqApiKey="${{ secrets.GROQ_API_KEY }}" \
          --set ingress.enabled=true \
          --set ingress.hosts[0].host="ai-log-tool-${{ steps.vars.outputs.environment }}.yourdomain.com" \
          --wait --timeout=300s

    - name: Verify deployment
      run: |
        kubectl rollout status deployment/${{ steps.vars.outputs.release_name }} -n ${{ steps.vars.outputs.namespace }}
        kubectl get pods -n ${{ steps.vars.outputs.namespace }}

    - name: Run health check
      run: |
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=ai-log-tool -n ${{ steps.vars.outputs.namespace }} --timeout=300s
        echo "Deployment successful!"
